---
alwaysApply: true
description: Essential project rules - always active. Data-driven, stateless, Decimal-only, UTC time.
---
# Essential Rules

## Core Principles (MANDATORY)

1. **Agent-Orchestrator Protocol**: Follow `.cursor/rules/orchestrator.mdc` for every task.
2. **Data-driven bottom-up**: Start with data analysis, never create strategies from theory.
3. **Stateless components**: No hidden state, everything via parameters.
4. **Self-validating code**: Input/output validation built into functions.
5. **Financial precision**: ALWAYS `Decimal` for money, NEVER `float`.
6. **UTC time only**: All timestamps in UTC.

## Pre-work Checklist

1. **Discovery**: Question the user and clarify goals (see Orchestrator protocol).
2. Check main plan: `*.plan.md`
3. Scan existing plans: `.cursor/plans/*`
3. Review project structure: `src/`
4. Use existing components: see `project_reference.mdc`

## Reuse First (CRITICAL)

ALWAYS check if component exists before creating new:

- **No one-off scripts**: NEVER create temporary diagnostic or utility scripts in the project root (e.g., `check_tickers.py`). Use existing `Repository`, `BrokerAdapter`, or existing `scripts/` utilities.
- Strategies → Strategy base class
- Brokers → BrokerAdapter interface  
- Risk → RiskManager (NEVER manual calc)
- Tickers → utils.tickers list
- Intervals → normalize_interval()
- DB → Repository interfaces only

## Planning (MANDATORY)

1. Create/update plan in `.cursor/plans/` before coding
2. Use `TEMPLATE.md` format
3. Wait for approval before starting
4. Update status during/after work

## Trading System Specifics

- Time: UTC everywhere  
- Tickers: From utils, never hardcode
- Brokers: BrokerAdapter interface
- Risk: RiskManager service
- Intervals: normalize_interval()

## Testing (MANDATORY)

1. **Verify Before Ship**: Run `pytest` on relevant modules after ANY substantive edit.
2. **Coverage**: New core features MUST have corresponding unit tests in `tests/unit/`.
3. **No Regressions**: Fix any broken tests immediately; never ignore test failures.
4. **Execution**: Run tests using: `export PYTHONPATH=$(pwd)/src && poetry run pytest tests/unit/...`

## Environment & Execution (CRITICAL)

To run Python scripts, ALWAYS use the following command structure from the project root:
```bash
export PYTHONPATH=$(pwd)/src && poetry run python scripts/.../your_script.py
```
This ensures the `src/` directory is in the Python path and all dependencies are loaded via Poetry.
