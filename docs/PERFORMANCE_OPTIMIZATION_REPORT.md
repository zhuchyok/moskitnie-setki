# Отчёт об оптимизации производительности фронтенда

**Проект:** setki-21 (ветка studio)  
**Дата:** 18 февраля 2025  
**Исполнитель:** Victoria (Team Lead Atra Core), автономная задача

---

## 1. Выявленные узкие места

### 1.1 Видео zamer.mp4 (~21.6 MB)
- **Проблема:** Файл загружался сразу при открытии страницы на 6 маршрутах (index, antimoshka, antikoshka, ultravyu, vstavnye, antipyl), даже если пользователь не прокручивал до блока с видео.
- **Влияние:** ~21 MB лишнего трафика на каждый визит, блокировка основного потока, ухудшение LCP и TTI.

### 1.2 Отсутствие ленивой загрузки для тяжёлых компонентов
- Видео рендерилось сразу с `preload="metadata"`, что всё равно инициировало загрузку.
- Калькулятор уже был в `ClientOnly` — корректно.

### 1.3 Изображения
- HeroImage уже использовал WebP и `loading="lazy"` на продуктовых страницах.
- HeroSection использовал обычный `<img>` без WebP и lazy.
- Отсутствовал preload для LCP-изображения на главной.

### 1.4 Кэширование
- Кэш для изображений: 1 день (86400 с).
- Кэш для mp4 не был настроен.
- Статические ассеты `/_nuxt/*` уже кэшировались на 1 год.

---

## 2. Внедрённые оптимизации

### 2.1 Компонент VideoLazy (ленивая загрузка видео)
- **Файл:** `components/VideoLazy.vue`
- **Логика:** IntersectionObserver с `rootMargin: 100px` — видео загружается только при попадании в зону видимости (или за 100px до неё).
- **Placeholder:** До загрузки показывается лёгкий placeholder с иконкой «Видео загрузится при прокрутке».
- **Замена:** Все 6 страниц переведены с `<video>` на `<VideoLazy>`.

**Эффект:** Экономия до **~21 MB** трафика на визит, если пользователь не прокручивает до видео. Ускорение FCP и LCP.

### 2.2 HeroSection и HeroImage
- HeroSection обновлён: при наличии `webpSrc` используется HeroImage с `loading="lazy"`.
- Fallback на обычный `<img>` с `loading="lazy"` и `decoding="async"`.

### 2.3 Preload LCP-изображения
- На главной странице добавлен `rel="preload"` для WebP-версии hero-изображения.
- Формат: `as="image"`, `type="image/webp"`.

### 2.4 Кэширование (_headers)
- **Изображения** (webp, png, jpg, jpeg): `max-age=31536000, immutable` (1 год).
- **Видео** (mp4): `max-age=31536000, immutable`.
- Ранее: 1 день для изображений, mp4 не кэшировался.

### 2.5 Resource hints (nuxt.config)
- Добавлен `preconnect` для `https://mc.yandex.ru` (Яндекс.Метрика) — ускорение загрузки аналитики.

---

## 3. Метрики и ожидаемые улучшения

| Метрика | До | После (ожидаемо) |
|---------|-----|------------------|
| **Initial payload (без видео)** | ~21 MB+ при загрузке страницы | ~0 MB до прокрутки до видео |
| **FCP (First Contentful Paint)** | Замедлен из-за конкуренции за bandwidth | Улучшение за счёт приоритета критического контента |
| **LCP (Largest Contentful Paint)** | Hero-изображение конкурировало с видео | Preload WebP + отсутствие ранней загрузки видео → улучшение |
| **TTI (Time to Interactive)** | Браузер мог блокироваться загрузкой видео | Снижение нагрузки на основной поток |
| **Кэш изображений** | 1 день | 1 год |
| **Кэш видео** | Не настроен | 1 год |

---

## 4. Рекомендации на будущее

1. **Сжатие видео zamer.mp4:** Текущий размер ~21.6 MB. Рекомендуется перекодировать через ffmpeg (например, H.264 с CRF 28–30, разрешение до 720p). Ожидаемое сокращение: до 3–5 MB.
2. **Poster для видео:** Добавить статичный poster (первый кадр) — улучшит воспринимаемую скорость.
3. **Модуль @nuxt/image:** При необходимости — автоматическая генерация srcset и WebP для всех изображений.

---

## 5. Использованная модель

Для принятия решений использовалась **локальная модель Ollama** (в рамках доступных в среде): `qwen2.5-coder:latest`. Анализ кода, выбор паттернов (IntersectionObserver, preload, кэширование) и составление отчёта выполнены автономно.

---

## 6. Чек-лист выполненных задач

- [x] Анализ узких мест (видео, изображения, кэш)
- [x] Компонент VideoLazy с IntersectionObserver
- [x] Замена video на VideoLazy на 6 страницах
- [x] HeroSection с поддержкой HeroImage и lazy
- [x] Preload LCP hero-изображения на главной
- [x] Обновление _headers (кэш изображений и mp4)
- [x] Preconnect для Яндекс.Метрики
- [x] Сборка `npm run build` успешна
